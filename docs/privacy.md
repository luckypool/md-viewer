# プライバシーとセキュリティ

MarkDrive はプライバシーを最優先に設計されています。このドキュメントでは、データの取り扱いとセキュリティについて説明します。

## 基本原則

### サーバーレス設計

MarkDrive は**完全にクライアントサイドで動作**します。

- ファイル内容をサーバーに送信しません
- ファイル内容をサーバーに保存しません
- すべての処理はブラウザ内で完結します

### データフロー

```
┌─────────────┐     OAuth認証      ┌─────────────┐
│   ブラウザ   │ ◄──────────────► │   Google    │
│  (MarkDrive) │                   │   OAuth     │
└──────┬──────┘                   └─────────────┘
       │
       │ ファイル取得（直接）
       ▼
┌─────────────┐
│   Google    │
│   Drive     │
└─────────────┘
```

**重要:** ファイル内容は Google Drive からブラウザに直接送信されます。中間サーバーは介在しません。

---

## データの取り扱い

### サーバーに送信されるデータ

MarkDrive のホスティングサーバー（Vercel）にはアプリケーションコードのみが配置されており、ユーザーデータは送信されません。

ただし、アクセス解析のために Google Analytics へ匿名の利用データ（ページビュー、デバイス情報等）が送信されます。詳細は「サードパーティサービス > アクセス解析」を参照してください。

### Google に送信されるデータ

| データ | 送信先 | 目的 |
|--------|--------|------|
| OAuth トークン | Google OAuth | 認証 |
| 検索クエリ | Google Drive API | ファイル検索 |
| ファイル ID | Google Drive API | ファイル取得 |

### ブラウザに保存されるデータ

| データ | ストレージ | 目的 |
|--------|-----------|------|
| Google アクセストークン | localStorage | セッション間の認証維持 |
| トークン有効期限 | localStorage | トークンの有効性チェック |
| テーマ設定 | localStorage | UI 設定の永続化 |
| 言語設定 | localStorage | UI 設定の永続化 |
| フォント設定 | localStorage | UI 設定の永続化 |
| ファイル履歴 | localStorage | 最近使ったファイルの表示 |
| ホーム画面バナー非表示 | localStorage | PWA バナーの表示制御 |

> **Note:** ファイル内容は一切保存されません。保存されるのはファイル ID と名前のみです。アクセストークンは有効期限（5分のマージン）を過ぎると自動的に無効扱いとなり、再認証が必要になります。

### 保存されないデータ

- ファイル内容
- 検索履歴
- 閲覧履歴（ファイル ID と名前以外）

---

## 認証とアクセス制御

### Google OAuth 2.0

MarkDrive は Google Identity Services (GIS) を使用した安全な認証を提供します。

**認証フロー:**
1. ユーザーが「Google でサインイン」をクリック
2. Google のポップアップウィンドウで認証
3. アクセストークンを取得（ブラウザのメモリに保持）
4. セッション終了時にトークンを破棄

### スコープ（権限）

MarkDrive が要求する権限は**最小限**です。

| スコープ | 説明 |
|---------|------|
| `drive.readonly` | Google Drive の読み取り専用アクセス |

**できること:**
- ファイルの検索
- ファイル内容の読み取り

**できないこと:**
- ファイルの作成
- ファイルの編集（Google Drive 上のファイルへの書き戻し）
- ファイルの削除
- ファイルの共有設定の変更

> **Note:** 編集モードでは Markdown をブラウザ内で編集できますが、Google Drive への書き戻しは行いません。変更はローカルファイルとして保存（File System Access API 対応ブラウザ）またはダウンロードされます。

### トークン管理

| 項目 | 説明 |
|------|------|
| 保存場所 | ブラウザの localStorage |
| 永続化 | する（セッション間で認証を維持） |
| 有効期限 | Google が発行した有効期限（5分のマージンで自動失効） |
| リフレッシュ | しない（有効期限切れ時は再認証が必要） |
| 削除 | サインアウト時にクリア |

---

## ローカルファイル

### 処理方法

ローカルファイルを開く場合:

1. File System Access API または File API でファイルを読み込み
2. ブラウザ内で Markdown をレンダリング
3. ファイル内容はメモリにのみ保持

**サーバーには一切送信されません。**

### 編集と保存

ローカルファイルの編集・保存は以下の方法で行われます:

- **File System Access API 対応ブラウザ**（Chrome, Edge 等）: 元のファイルを直接上書き保存
- **非対応ブラウザ**: 新しいファイルとしてダウンロード

いずれの場合も、ファイル内容がサーバーに送信されることはありません。

### 履歴

ローカルファイルの履歴には以下のみ保存されます:
- ファイル名
- ファイル ID（ランダム生成）
- ソース（`local`）

ファイル内容やファイルパスは保存されません。

---

## サードパーティサービス

### Google

MarkDrive は Google の以下のサービスを使用します:

| サービス | 用途 | プライバシーポリシー |
|---------|------|---------------------|
| Google Identity Services | OAuth 認証 | [Google プライバシーポリシー](https://policies.google.com/privacy) |
| Google Drive API | ファイル検索・取得 | [Google Drive 利用規約](https://www.google.com/drive/terms-of-service/) |

### アクセス解析

| サービス | 用途 | プライバシーポリシー |
|---------|------|---------------------|
| Google Analytics | アクセス解析（ページビュー等） | [Google プライバシーポリシー](https://policies.google.com/privacy) |

MarkDrive はサービス改善のために Google Analytics を使用し、以下の匿名データを収集します:

- ページビュー
- おおよその地域情報
- デバイス・ブラウザの種類

**収集しないデータ:**
- ファイル内容
- Google Drive のファイル名・ファイル ID
- 個人を特定できる情報

> Google Analytics はブラウザの Cookie を使用します。Cookie の使用を望まない場合は、ブラウザの設定で無効にするか、[Google Analytics オプトアウトアドオン](https://tools.google.com/dlpage/gaoptout)をご利用ください。

### ホスティング

| サービス | 用途 | プライバシーポリシー |
|---------|------|---------------------|
| Vercel | アプリケーションホスティング | [Vercel プライバシーポリシー](https://vercel.com/legal/privacy-policy) |

---

## セキュリティ対策

### XSS 対策

- React のエスケープ機能を活用
- `dangerouslySetInnerHTML` の使用を最小限に
- Markdown レンダリングには react-markdown を使用（サニタイズ済み）

### HTTPS

- すべての通信は HTTPS で暗号化
- Google API への通信も HTTPS

### Content Security Policy

Vercel のデフォルト設定に従います。

---

## データ削除

### ブラウザデータの削除

以下の方法でブラウザに保存されたデータを削除できます:

**方法1: アプリ内で削除**
- ホーム画面の「クリア」ボタンで履歴を削除

**方法2: ブラウザの設定**
- ブラウザの設定 → サイトデータの削除

### Google 連携の解除

1. [Google アカウントのセキュリティ設定](https://myaccount.google.com/permissions)にアクセス
2. 「MarkDrive」を選択
3. 「アクセス権を削除」をクリック

---

## お問い合わせ

プライバシーに関するご質問は、GitHub Issue でお問い合わせください。

https://github.com/luckypool/mark-drive/issues
